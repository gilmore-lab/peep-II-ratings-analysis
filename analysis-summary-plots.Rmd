---
title: "PEEP-II Behavioral Ratings"
date: "`r Sys.time()`"
author: "Rick Gilmore"
output:
  github_document:
    html_preview: true
    toc: true
    toc_depth: 3
  html_notebook: default
  pdf_document:
    toc: true
    toc_depth: 3
---

## Purpose

This notebook documents the process of exploring the PEEP-II ratings data.

## Preliminaries

Load libraries.

```{r preliminaries}
library(tidyverse)
library(stringr)
```

## Copy data and import

The behavioral data are currently (2017-06-20-15:02) stored in `~/Box\ Sync/b-peep-project\ Shared/PEEP2\ data/PEEP2\ Home\ visit\ behavioural\ data/` as a set of `*.csv` files.

```{r import-data-test}
peep2.data.dir <- "~/Box\ Sync/b-peep-project\ Shared/PEEP2\ data/PEEP2\ Home\ visit\ behavioural\ data/"

# List files and open one for inspection
peep2.flist <- list.files(path = peep2.data.dir, pattern = "\\.csv$", full.names = TRUE)
peep2.test.df <- read.csv(file = peep2.flist[1])
str(peep2.test.df)
```

It looks like the data files are well-structured and the variable names clear. **Note** that the ratings are on a [1,4] scale. I don't recall what the `know_speaker` ratings reflect now, but I will check.

Let's proceed to import the existing data and combine it into one file for visualization.

```{r import-and-merge}
peep2.df.list <- lapply(peep2.flist, read.csv)
peep2.df <- Reduce(function(x,y) merge(x,y, all =TRUE), peep2.df.list)
str(peep2.df)
```

It looks like the `scared.rating` occurs in some of the later data files, but was not present in the first one we examined. Note that that we do not have a variable that specifies the target prosody {'ang', 'hap', 'neu', 'sad'}, the script type {'chk', ...}, or the script variation {'a', 'b'}, but that these are available from the `snd_file` name. It should be relatively easy to pull those from the `snd_file` names. Let's see.

```{r extract-snd-info-from-name}
# Pick character ranges by hand
peep2.df$target_prosody <- str_sub(peep2.df$snd_file, 18, 20)
peep2.df$script_name <- str_sub(peep2.df$snd_file, 22, 24)
peep2.df$script_variation <- str_sub(peep2.df$snd_file, 26, 26)
```

## Mapping between ratings and image icons

### Angry ratings

| 1 | 2  | 3 | 4 |
| :-: | :-: | :-: | :-: | :-: |
| <img src="img/ang-1.jpg" width=150px/> | <img src="img/ang-2.jpg", width=150px/> | <img src="img/ang-3.jpg", width=150px/> | <img src="img/ang-4.jpg", width=150px/> |

### Happy ratings

| 1 | 2  | 3 | 4 |
| :-: | :-: | :-: | :-: | :-: |
| <img src="img/hap-1.jpg" width=150px/> | <img src="img/hap-2.jpg", width=150px/> | <img src="img/hap-3.jpg", width=150px/> | <img src="img/hap-4.jpg", width=150px/> |

### Sad ratings

| 1 | 2  | 3 | 4 |
| :-: | :-: | :-: | :-: | :-: |
| <img src="img/sad-1.jpg" width=150px/> | <img src="img/sad-2.jpg", width=150px/> | <img src="img/sad-3.jpg", width=150px/> | <img src="img/sad-4.jpg", width=150px/> |

### Scared ratings

| 1 | 2  | 3 | 4 |
| :-: | :-: | :-: | :-: | :-: |
| <img src="img/sca-1.jpg" width=150px/> | <img src="img/sca-2.jpg", width=150px/> | <img src="img/sca-3.jpg", width=150px/> | <img src="img/sca-4.jpg", width=150px/> 

### How feel ratings

| Neutral | Happy | Angry | Sad | Scared |
| :-: | :-: | :-: | :-: | :-: |
| <img src="img/sad-1.jpg" width=150px/> | <img src="img/hap-3.jpg", width=150px/> | <img src="img/ang-3.jpg", width=150px/> | <img src="img/sad-3.jpg", width=150px/> | <img src="img/sca-3.jpg", width=150px/> |
| 1 | 2 | 3 | 4 | 5 |

## Angry prosody

### Angry ratings

```{r angry-prosody-angry-ratings}
peep2.df %>%
  filter(target_prosody %in% "ang") %>%
  ggplot() +
  # aes(x = script_name, y = angry_rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = angry_rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Angry prosody: Anger ratings")
```

### Happy ratings

```{r angry-prosody-happy-rating}
peep2.df %>%
  filter(target_prosody %in% "ang") %>%
  ggplot() +
  # aes(x = script_name, y = happy_rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = happy_rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Angry prosody: Happy ratings")
```

### Sad ratings

```{r angry-prosody-sad-rating}
peep2.df %>%
  filter(target_prosody %in% "ang") %>%
  ggplot() +
  # aes(x = script_name, y = sad_rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = sad_rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Angry prosody: Sad ratings")
```

### Scared ratings

```{r angry-prosody-scared-rating}
peep2.df %>%
  filter(target_prosody %in% "ang") %>%
  ggplot() +
  # aes(x = script_name, y = scared.rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = scared.rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Angry prosody: Scared ratings")
```

### How feel ratings

The `how_feel` variable codes on a [1,5] scale the participant's response to the question: 'How did this make you feel?'

The mapping from facial expression to image exemplar was as follows: 1 = neutral, 2 = mid-happy, 3 = mid-angry, 4= mid-sad, 5 = mid-scared.

```{r angry-prosody-how-feel}
peep2.df %>%
  filter(target_prosody %in% "ang") %>%
  ggplot() +
  # aes(x = script_name, y = how_feel) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = how_feel) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Angry prosody: How does it make you feel?")
```

Remember...

| Neutral | Happy | Angry | Sad | Scared |
| :-: | :-: | :-: | :-: | :-: |
| <img src="img/sad-1.jpg" width=150px/> | <img src="img/hap-3.jpg", width=150px/> | <img src="img/ang-3.jpg", width=150px/> | <img src="img/sad-3.jpg", width=150px/> | <img src="img/sca-3.jpg", width=150px/> |
| 1 | 2 | 3 | 4 | 5 |

## Happy prosody

### Happy ratings

```{r happy-prosody-happy-rating}
peep2.df %>%
  filter(target_prosody %in% "hap") %>%
  ggplot() +
  # aes(x = script_name, y = happy_rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = happy_rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Happy prosody: Happy ratings")
```

### Angry ratings

```{r happy-prosody-angry-rating}
peep2.df %>%
  filter(target_prosody %in% "hap") %>%
  ggplot() +
  # aes(x = script_name, y = angry_rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = angry_rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Happy prosody: Angry ratings")
```

### Sad ratings

```{r happy-prosody-sad-rating}
peep2.df %>%
  filter(target_prosody %in% "hap") %>%
  ggplot() +
  # aes(x = script_name, y = sad_rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = sad_rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Happy prosody: Sad ratings")
```

### Scared ratings

```{r happy-prosody-scared-rating}
peep2.df %>%
  filter(target_prosody %in% "hap") %>%
  ggplot() +
  # aes(x = script_name, y = scared.rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = scared.rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Happy prosody: Scared ratings")
```

### How feel ratings

```{r happy-prosody-how-feel}
peep2.df %>%
  filter(target_prosody %in% "hap") %>%
  ggplot() +
  # aes(x = script_name, y = how_feel) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = how_feel) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Happy prosody: How does it make you feel?")
```

## Sad prosody

### Sad ratings

```{r sad-prosody-sad-ratings}
peep2.df %>%
  filter(target_prosody %in% "sad") %>%
  ggplot() +
  # aes(x = script_name, y = sad_rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = sad_rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Sad prosody: Sad ratings")
```

### Angry ratings

```{r sad-prosody-angry-ratings}
peep2.df %>%
  filter(target_prosody %in% "sad") %>%
  ggplot() +
  # aes(x = script_name, y = angry_rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = angry_rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Sad prosody: Angry ratings")
```

### Happy ratings

```{r sad-prosody-happy-ratings}
peep2.df %>%
  filter(target_prosody %in% "sad") %>%
  ggplot() +
  # aes(x = script_name, y = happy_rating) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = happy_rating) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Sad prosody: Happy ratings")
```

### How feel ratings

```{r sad-prosody-how-feel}
peep2.df %>%
  filter(target_prosody %in% "sad") %>%
  ggplot() +
  # aes(x = script_name, y = how_feel) + 
  # geom_violin() +
  # facet_grid(. ~ script_variation) +
  aes(x = how_feel) +
  geom_histogram() +
  facet_grid(script_name ~ script_variation) +
  ggtitle("Sad prosody: How does it make you feel?")
```

## Comparative ratings

```{r compare-ratings}

# Note that the `gather` command wants the variables in
# alphabetical order. I don't know why
peep2.gathered.df <- gather(peep2.df, `angry_rating`, `happy_rating`, `sad_rating`, `scared.rating`, key = "rating_type", value = "intensity")

# peep2.gathered.df$rating_type <- as.factor(peep2.gathered.df$rating_type)
# 
# levels(peep2.gathered.df$rating_type) <- c("ang", "hap", "sad", "sca")

peep2.gathered.df %>%
  ggplot() +
  aes(x=intensity) +
  facet_grid(rating_type ~ target_prosody) +
  geom_histogram()
```

This suggests that the angry scripts were perceived as angry, but not happy, sad, or scary. The happy scripts were perceived as happy, but not angry, sad, or scary. The neutral scripts were perceived as moderately sad, but not angry, sad, or scary. The sad scripts were perceived as sad, but not angry, happy, or scary.

## Time series of ratings

During the scanning session, participants heard the scripts in a fixed temporal order. It would be useful to visualize the time series of the internal state they might have experienced assuming that state is equal to the post hoc ratings. So, let's imagine a data table that looks something like this:

sound_index,intensity,rating_type

Then we plot as separate time series the trial x *_rating values, perhaps like this:

```{r, time-series-run-1}
this_fam = 1
this_run = 1
title_text = sprintf("Time series of rated intensity: Family %d / Run %d", this_fam, this_run)
peep2.gathered.df %>%
  filter(fam_id == 1, run == 2) %>%
  ggplot() +
  aes(x=sound_index, y=intensity, color = target_prosody) +
  geom_point(size = 1) +
  geom_line() +
  facet_grid(rating_type ~ .) +
  ggtitle(title_text)
```

And here is run 2:

```{r, time-series-run-2}
this_fam = 1
this_run = 2
title_text = sprintf("Time series of rated intensity: Family %d / Run %d", this_fam, this_run)
peep2.gathered.df %>%
  filter(fam_id == 1, run == 2) %>%
  ggplot() +
  aes(x=sound_index, y=intensity, color = target_prosody) +
  geom_point(size = 1) +
  geom_line() +
  facet_grid(rating_type ~ .) +
  ggtitle(title_text)
```

Let's try combining the two runs into one plot

```{r, time-series-all-runs-fam-1}
this_fam = 1
title_text = sprintf("Time series of rated intensity: Family %d", this_fam)
peep2.gathered.df %>%
  filter(fam_id == 1) %>%
  ggplot() +
  aes(x=sound_index, y=intensity, color = target_prosody) +
  geom_point(size = 1) +
  geom_line() +
  facet_grid(rating_type ~ run) +
  ggtitle(title_text)
```

And here is family 2.

```{r, time-series-all-runs-fam-2}
this_fam = 2
title_text = sprintf("Time series of rated intensity: Family %d", this_fam)
peep2.gathered.df %>%
  filter(fam_id == this_fam) %>%
  ggplot() +
  aes(x=sound_index, y=intensity, color = target_prosody) +
  geom_point(size = 1) +
#  geom_line() +
  geom_smooth(se = FALSE) +
  facet_grid(rating_type ~ run) +
  ggtitle(title_text)
```

Here's another version that adds a black step function to show how the ratings change stimulus to stimulus.

```{r, time-series-all-runs-fam-2-smooth}
this_fam = 2
title_text = sprintf("Time series of rated intensity: Family %d", this_fam)
peep2.gathered.df %>%
  filter(fam_id == this_fam) %>%
  ggplot() +
  aes(x=sound_index, y=intensity) +
  geom_step(color = 'black') +
  geom_point(size = 1, aes(color=target_prosody)) +
  geom_smooth(se=FALSE, aes(color=target_prosody)) +
  facet_grid(rating_type ~ run) +
  ggtitle(title_text)
```

## Next steps

1. Combine ratings so that it is easier to compare how happy, angry, sad, scared each script was rated. Gather the ratings into a single variable in a new data frame. See <https://www.rstudio.com/resources/cheatsheets/>.
  - This is partially done as of 2017-06-27.
2. Visualize the time series of ratings.
  - This is partially done as of 2017-07-11.
3. Conduct cluster analyses on ratings to confirm classification.
4. Merge with participant metadata.
5. Add analysis of `know_speaker` variable.

And here are some stylistic/low priority activities:

1. Write a function to generate plots parametrically.
2. Explore other `bookdown` features like figure captions.

## Resources

This analysis was conducted in RStudio version 1.0.143 on `r Sys.time()`. Additional information about the working environment is as follows:

```{r package-summary}
sessionInfo()
```

